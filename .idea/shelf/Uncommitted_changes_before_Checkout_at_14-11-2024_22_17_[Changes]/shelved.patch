Index: src/main/java/com/Klaus/be_service/util/MailSchedulerService.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.Klaus.be_service.util;\r\n\r\nimport org.springframework.beans.factory.annotation.Autowired;\r\nimport org.springframework.beans.factory.annotation.Value;\r\nimport org.springframework.mail.javamail.JavaMailSender;\r\nimport org.springframework.mail.javamail.MimeMessageHelper;\r\nimport org.springframework.scheduling.annotation.Scheduled;\r\nimport org.springframework.stereotype.Service;\r\n\r\nimport javax.mail.MessagingException;\r\nimport javax.mail.internet.InternetAddress;\r\nimport javax.mail.internet.MimeMessage;\r\nimport java.io.*;\r\n\r\n@Service\r\npublic class MailSchedulerService {\r\n    @Value(\"${jasper.filePath}\")\r\n    private String jasperFilePath;\r\n\r\n    @Autowired\r\n    private JavaMailSender mailSender;\r\n\r\n\r\n    // Limit to avoid exceeding Gmail's sending limit\r\n    private static final int EMAILS_PER_BATCH = 100;\r\n    private static final long DELAY_BETWEEN_EMAILS_MS = 300000; // Delay between each email (e.g., 2 seconds)\r\n    private static final long DELAY_BETWEEN_BATCHES_MS = 24 * 60 * 60 * 1000;\r\n\r\n\r\n    // One-time scheduler: Schedule the task to run once on application startup\r\n    @Scheduled(initialDelay = 5000, fixedRate = Long.MAX_VALUE)\r\n    public void sendEmails() {\r\n        try (BufferedReader br = new BufferedReader(new FileReader(jasperFilePath))) {\r\n            String email;\r\n            int emailsSent = 0;\r\n\r\n            while ((email = br.readLine()) != null) {\r\n                try {\r\n                    sendHtmlEmail(email);\r\n                    System.out.println(\"Email sent to: \" + email);\r\n                    emailsSent++;\r\n\r\n                    // Throttle emails to avoid Gmail limits\r\n                    Thread.sleep(DELAY_BETWEEN_EMAILS_MS);\r\n\r\n                    // Limit emails per batch\r\n                    if (emailsSent % EMAILS_PER_BATCH == 0) {\r\n                        System.out.println(\"Batch limit reached, waiting before sending next batch...\");\r\n                        Thread.sleep(DELAY_BETWEEN_BATCHES_MS);\r\n                    }\r\n\r\n                } catch (Exception e) {\r\n                    System.out.println(\"Failed to send email to: \" + email + \". Error: \" + e.getMessage());\r\n                    // Implement retry with backoff if required\r\n//                    handleFailedEmail(email, e);\r\n                }\r\n            }\r\n        } catch (IOException e) {\r\n            System.out.println(\"Error reading email file or interruption: \" + e.getMessage());\r\n        }\r\n    }\r\n\r\n\r\n\r\n    private void sendHtmlEmail(String toEmail) throws MessagingException, UnsupportedEncodingException {\r\n        MimeMessage message = mailSender.createMimeMessage();\r\n        MimeMessageHelper helper = new MimeMessageHelper(message, true, \"UTF-8\");\r\n\r\n        helper.setTo(toEmail);\r\n        helper.setSubject(\"Besonderes Angebot für Geschäftskunden\");\r\n\r\n        helper.setFrom(new InternetAddress(\"kundendienst@bmw-scheller.com\", \"reply@bmw-scheller.com\"));\r\n\r\n        // Set the HTML content\r\n        String htmlContent = \"<style>\\n\" +\r\n                \"    @media (min-width: 768px) {\\n\" +\r\n                \"        .car-info-container {\\n\" +\r\n                \"            display: flex;\\n\" +\r\n                \"            justify-content: space-between;\\n\" +\r\n                \"            align-items: center;\\n\" +\r\n                \"        }\\n\" +\r\n                \"        .car-info-text {\\n\" +\r\n                \"            flex: 1;\\n\" +\r\n                \"            padding-right: 20px;\\n\" +\r\n                \"        }\\n\" +\r\n                \"        .car-info-image {\\n\" +\r\n                \"            flex: 0 0 125px; /* Set width to a small size for desktop */\\n\" +\r\n                \"            text-align: right;\\n\" +\r\n                \"        }\\n\" +\r\n                \"        .car-info-image img {\\n\" +\r\n                \"            width: 125px; /* Small image size for desktop */\\n\" +\r\n                \"            border-radius: 8px;\\n\" +\r\n                \"        }\\n\" +\r\n                \"    }\\n\" +\r\n                \"</style>\\n\" +\r\n                \"\\n\" +\r\n                \"<div style=\\\"font-family: Arial, sans-serif;\\\">\\n\" +\r\n                \"    <div style=\\\"background-color: #333; color: #fff; padding: 20px; text-align: center;\\\">\\n\" +\r\n                \"        <h2>Besonderes Angebot für Geschäftskunden</h2>\\n\" +\r\n                \"    </div>\\n\" +\r\n                \"    <div style=\\\"padding: 20px;\\\">\\n\" +\r\n                \"        <p>Sehr geehrte Damen und Herren,</p>\\n\" +\r\n                \"        <p>wir freuen uns, Ihnen ein spezielles Angebot für Geschäftskunden anzukündigen. Profitieren Sie von günstigen Konditionen auf unser Sortiment an hochwertigen Gebrauchtwagen.</p>\\n\" +\r\n                \"        <p>Unser Angebot umfasst eine breite Auswahl an Marken und Modellen, die ideal für den Wiederverkauf geeignet sind.</p>\\n\" +\r\n                \"        <p>Sehen Sie sich unsere aktuellen Fahrzeuge an – klicken Sie auf den Anhang, um den aktuellen Fahrzeugkatalog herunterzuladen und Ihr Wunschauto zu finden!</p>\\n\" +\r\n                \"        \\n\" +\r\n                \"        <div class=\\\"car-info-container\\\" style=\\\"background-color: #444; color: #fff; padding: 10px; margin: 20px 0;\\\">\\n\" +\r\n                \"            <div class=\\\"car-info-text\\\">\\n\" +\r\n                \"                <h3>BMW 2er Coupé M</h3>\\n\" +\r\n                \"                <p>Erstzulassung: 02/2022<br>\\n\" +\r\n                \"                   Kilometerstand: 41.100 km<br>\\n\" +\r\n                \"                   Leistung: 135 kW / 184 PS<br>\\n\" +\r\n                \"                   Getriebe: Automatik<br>\\n\" +\r\n                \"                   Bestandsnummer: BMWS01</p>\\n\" +\r\n                \"            </div>\\n\" +\r\n                \"            <div class=\\\"car-info-image\\\">\\n\" +\r\n                \"                <img src=\\\"cid:carImage\\\" alt=\\\"BMW 2er Coupé M\\\">\\n\" +\r\n                \"                <h2 style=\\\"color: yellow; margin-top: 10px;\\\">31.900,00 €</h2>\\n\" +\r\n                \"                <p>inklusive Mehrwertsteuer</p>\\n\" +\r\n                \"            </div>\\n\" +\r\n                \"        </div>\\n\" +\r\n                \"\\n\" +\r\n                \"        <p>Haben Sie bereits das geeignete Fahrzeug entdeckt? Bitte senden Sie Ihre Antwort mit der entsprechenden Angebotsnummer an <a href=\\\"mailto:kundendienst@bmw-scheller.com\\\" style=\\\"color: #ccc; text-decoration: none;\\\">kundendienst@bmw-scheller.com</a>.</p>\\n\" +\r\n                \"        <p>For foreign customers, we offer the same service in English. If you are interested, please reply to <a href=\\\"mailto:kundendienst@bmw-scheller.com\\\" style=\\\"color: #ccc; text-decoration: none;\\\">kundendienst@bmw-scheller.com</a>, and a service representative will contact you as soon as possible.</p>\\n\" +\r\n                \"    </div>\\n\" +\r\n                \"    <footer style=\\\"background-color: #333; color: #fff; padding: 10px; text-align: center;\\\">\\n\" +\r\n                \"        <p><a href=\\\"mailto:kundendienst@bmw-scheller.com\\\" style=\\\"color: #ccc; text-decoration: none;\\\">kundendienst@bmw-scheller.com</a> | <a href=\\\"https://bmw-scheller.com\\\" style=\\\"color: #ccc; text-decoration: none;\\\">bmw-scheller.com</a></p>\\n\" +\r\n                \"        <p>© 2024 KLAUS SCHELLER GMBH</p>\\n\" +\r\n                \"    </footer>\\n\" +\r\n                \"</div>\\n\";\r\n\r\n\r\n        helper.setText(htmlContent, true);\r\n\r\n        // Attach an image if needed\r\n        helper.addInline(\"carImage\", new File(\"/app/email/car.png\"));\r\n\r\n        // Replace with the actual image path\r\n\r\n        helper.setReplyTo(\"kundendienst@bmw-scheller.com\");\r\n\r\n        helper.addAttachment(\"Klaus Scheller GmbH Katalog Herbst 2024 Ausgabe.pdf\", new File(\"/app/email/Klaus Scheller GmbH Katalog Herbst 2024 Ausgabe.pdf\")); // Replace with the actual PDF path\r\n\r\n        mailSender.send(message);\r\n    }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/Klaus/be_service/util/MailSchedulerService.java b/src/main/java/com/Klaus/be_service/util/MailSchedulerService.java
--- a/src/main/java/com/Klaus/be_service/util/MailSchedulerService.java	(revision f7dbdde8e32c15cf1128707b7f56e219ddf144cd)
+++ b/src/main/java/com/Klaus/be_service/util/MailSchedulerService.java	(date 1731602117810)
@@ -133,7 +133,7 @@
         helper.setText(htmlContent, true);
 
         // Attach an image if needed
-        helper.addInline("carImage", new File("/app/email/car.png"));
+//        helper.addInline("carImage", new File("/app/email/car.png"));
 
         // Replace with the actual image path
 
